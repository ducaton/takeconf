# Клиент системы удалённого применения настроек

**Только для операционных систем на основе ядра Linux**

### Описание

Клиент в первую очередь посылает номер версии локального файла конфигурации серверу. Если версия не совпала, сервер сформирует новый файл и пошлёт его клиенту. Клиент постарается применить настройки, отчитается об успешности их применения и, если применение прошло без ошибок, сохранит файл у себя, дополнительно создав файл, содержащий версию конфигурации. Файл сохраняется, чтобы в будущем не применять настройки, которые не изменились.

Клиент запускается в фоне и с некоторым интервалом. Для такой интеграции в систему используются systemd-файлы таймера и службы.

Алгоритм работы клиентской части:

![Алгоритм](/README-assets/client-algorithm.png)

Применение настроек происходит при помощи вызова программой client.c заранее написанных shell-сценариев. Примеры таких сценариев находятся в каталоге ./samba/templates. В каталоге pc сценарии предназначены для изменение настроек компьютера, а в каталоге users для изменения пользовательских настроек. **Возможно представленные сценарии не годятся для реального применения.**

Логика преобразования файла конфигурации:

![Преобразование .json](/README-assets/json-to-sh.png)

Каталог samba при реальном применении должен являться сетевым диском. В нём содержатся файлы, необходимые для применения настроек.

Для проверки функционирования клиента разработан отладочный сервер. К серверу относятся файлы:

- `server.c` (отладочный сервер),
- `config.json` (файл конфигурации),
- `version` (версия файла конфигурации).

### Конфигурация программы

Файл конфигурации takeconf располагается по пути `/etc/takeconf/takeconf.conf`. Там необходимо указать адрес сервера (`server_name=localhost` или `server_name=127.0.0.1`) и порт подключения (`port=49152`).

### Запуск отладочного сервера

1. `cc -o server server.c -l json-c -l bsd`
2. `./server`

### Установка и запуск клиентской части

1. `cc -o client client.c -l json-c -l bsd`
2. `cp ./client /bin/takeconf`
3. 
    ```
    cp ./takeconf.service /etc/systemd/system/  
    cp ./takeconf.timer /etc/systemd/system/  
    systemctl daemon-reload
    ```
4. `printf "server_name=localhost\nport=49152">/etc/takeconf/takeconf.conf`
5. 
    ```
    systemctl start takeconf.timer  
    systemctl enable takeconf.timer
    ```

### Демонстрация работы

Состояние системы до применения настроек. Локальный файл конфигурации отсутствует, корзина скрыта с рабочего стола, на обоях горы:

![До применения](/README-assets/beforeя.png)

Состояние системы после применения настроек. Сервер прислал настройки, изображённые на окне слева-cнизу. Поскольку настройки применились без ошибок, в локальный файл конфигурации и файл версии записались данные с сервера. Клиент проверил, установлен ли пакет «git», сменил обои, включил видимость корзины, создал каталог с пользователем «ivan» и занёс в него файл с автозапуском:

![После применения](/README-assets/after.png)

Состояние системы после неудачного применения настроек. Поскольку одна настройка не выполнилась, локальные файлы конфигурации и версии не были созданы. Несмотря на ошибку, остальные настройки применились:

![Применение с ошибкой](/README-assets/after-err.png)